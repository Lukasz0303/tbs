<p-toast key="profile" position="top-right"></p-toast>

@if (currentUser$ | async; as user) {
  <div class="profile-container">
    <div class="profile-header">
      <h1>{{ translate.translate('profile.title') }}</h1>
    </div>

    <div class="profile-content-wrapper">
      <div class="profile-main-section">
        <div class="profile-card">
          <div class="profile-content">
            <div class="avatar-section">
              <div class="profile-name">{{ user.username || translate.translate('profile.guest') }}</div>
              <div class="avatar-wrapper">
                <div class="avatar-container">
                  <img [src]="getAvatarPath(user.avatar)" alt="Avatar" class="avatar-image" />
                </div>
                @if (!user.isGuest) {
                  <button
                    pButton
                    type="button"
                    class="avatar-edit-button"
                    icon="pi pi-pencil"
                    size="small"
                    (click)="onEditAvatar($event)"
                    [title]="translate.translate('profile.avatar.edit')"
                    aria-label="Edit avatar">
                  </button>
                }
              </div>
            </div>
            @if (!user.isGuest) {
              <div class="stats-section">
                <div class="stat-item">
                  <span class="stat-label">{{ translate.translate('profile.stats.points') }}</span>
                  <span class="stat-value">{{ user.totalPoints || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ translate.translate('profile.stats.gamesPlayed') }}</span>
                  <span class="stat-value">{{ user.gamesPlayed || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ translate.translate('profile.stats.gamesWon') }}</span>
                  <span class="stat-value">{{ user.gamesWon || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ translate.translate('profile.stats.winRate') }}</span>
                  <span class="stat-value">{{ getWinRate(user) }}%</span>
                </div>
              </div>
            }
          </div>
        </div>
      </div>

      <div class="profile-info-section">
        <div class="profile-info-card">
          <h2>{{ translate.translate('profile.info.title') }}</h2>
          <div class="info-row">
            <span class="info-label">{{ translate.translate('profile.username') }}:</span>
            <span class="info-value">
              {{ user.username || translate.translate('profile.guest') }}
              @if (!user.isGuest) {
                <button
                  pButton
                  type="button"
                  [label]="translate.translate('profile.edit')"
                  icon="pi pi-pencil"
                  severity="secondary"
                  size="small"
                  (click)="onEditUsername()">
                </button>
              }
            </span>
          </div>
          @if (!user.isGuest && user.email) {
            <div class="info-row">
              <span class="info-label">{{ translate.translate('profile.email') }}:</span>
              <span class="info-value">{{ user.email }}</span>
            </div>
          }
          <div class="info-row">
            <span class="info-label">{{ translate.translate('profile.status') }}:</span>
            <span class="info-value">
              {{ user.isGuest ? translate.translate('profile.guest') : translate.translate('profile.registered') }}
            </span>
          </div>
          @if (!user.isGuest) {
            <div class="logout-row">
              <button
                pButton
                type="button"
                [label]="translate.translate('home.hero.logoutButton')"
                icon="pi pi-sign-out"
                severity="danger"
                (click)="onLogout()">
              </button>
            </div>
          }
        </div>
      </div>

      @if (lastGame$ | async; as lastGame) {
        <div class="last-game-section">
          <app-last-game-card
            [game]="lastGame"
            (continueGame)="onContinueGame($event)">
          </app-last-game-card>
        </div>
      }

      @if (user.isGuest) {
        <div class="registration-encouragement">
          <h3>{{ translate.translate('profile.registerEncouragement.title') }}</h3>
          <p>{{ translate.translate('profile.registerEncouragement.description') }}</p>
          <button
            pButton
            type="button"
            [label]="translate.translate('profile.registerButton')"
            (click)="navigateToRegister()">
          </button>
        </div>
      }
    </div>
  </div>

  @if (showEditDialog()) {
    <app-edit-username-dialog
      [currentUsername]="user.username || ''"
      (close)="onCloseEditDialog()"
      (save)="onSaveUsername($event)">
    </app-edit-username-dialog>
  }

  @if (showAvatarDialog()) {
    <app-avatar-selector
      [visible]="showAvatarDialog()"
      [currentAvatar]="user.avatar"
      [isLoading]="isSavingAvatar()"
      (visibleChange)="onAvatarDialogVisibleChange($event)"
      (close)="onCloseAvatarDialog()"
      (save)="onSaveAvatar($event)">
    </app-avatar-selector>
  }
} @else {
  <div class="profile-container">
    <div class="loading-container">
      <p>{{ translate.translate('profile.loading') }}</p>
    </div>
  </div>
}
